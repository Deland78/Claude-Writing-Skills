$schema: "https://json-schema.org/draft/2020-12/schema"
$id: "trace_record/v1"
title: Trace Record
description: Complete session record for a pipeline step, used for evals and reproducibility.

type: object
required:
  - timestamp
  - step
  - level
  - mode
  - context_loaded
  - cost

properties:
  timestamp:
    type: string
    format: date-time
    description: "ISO 8601 timestamp of the session."
  step:
    type: string
    description: "Step identifier."
  level:
    type: string
    enum: ["L1", "L2", "L3", "L4", "L5"]
  mode:
    type: string
    enum: ["manual", "mob"]
  model_config:
    type: object
    description: "Map of agent names to model identifiers used in this session."
    additionalProperties:
      type: string
  context_loaded:
    type: array
    items:
      type: object
      required:
        - file
      properties:
        file:
          type: string
        tokens:
          type: integer
          description: "Estimated token count for this file."
    description: "Files loaded as context with token estimates."
  phases:
    type: object
    properties:
      structure:
        type: object
        properties:
          human_input:
            type: string
          lead_editor_output:
            type: string
          human_accepted:
            type: boolean
          adjustments:
            type: string
      comments:
        type: array
        items:
          $ref: "agent_comment/v1"
      commit:
        type: object
        properties:
          artifact_file:
            type: string
          relationships_added:
            type: integer
          relationships_changed:
            type: integer
          canon_version:
            type: integer
  cost:
    type: object
    required:
      - total_usd
    properties:
      total_usd:
        type: number
      by_agent:
        type: object
        additionalProperties:
          type: object
          properties:
            model:
              type: string
            input_tokens:
              type: integer
            output_tokens:
              type: integer
            cost_usd:
              type: number
  reproducibility:
    type: object
    properties:
      context_manifest_hash:
        type: string
      canon_version:
        type: integer
      agent_config:
        type: object
    description: "Reproducibility bundle for this session."

additionalProperties: false
